<!-- TOC -->

- [1. 网络层](#1-网络层)
    - [1.1. 概述](#11-概述)
        - [1.1.1. 转发和选路](#111-转发和选路)
        - [1.1.2. 网络服务模型](#112-网络服务模型)
    - [1.2. 虚电路和数据报网络](#12-虚电路和数据报网络)
        - [1.2.1. 虚电路网络](#121-虚电路网络)
        - [1.2.2. 数据报网络](#122-数据报网络)
    - [1.3. 路由器工作原理](#13-路由器工作原理)
        - [1.3.1. 输入端口](#131-输入端口)
        - [1.3.2. 交换结构](#132-交换结构)
        - [1.3.3. 输出端口](#133-输出端口)
        - [1.3.4. 何时出现排队](#134-何时出现排队)
    - [1.4. 网际协议：因特网中的转发和编址](#14-网际协议因特网中的转发和编址)
        - [1.4.1. 数据报格式](#141-数据报格式)
        - [1.4.2. IPv4编址](#142-ipv4编址)
        - [1.4.3. ICMP：互联网控制报文协议](#143-icmp互联网控制报文协议)
    - [1.5. 选路算法](#15-选路算法)
    - [1.6. 因特网中的选路](#16-因特网中的选路)
        - [1.6.1. 因特网中自治系统内部选路：IP](#161-因特网中自治系统内部选路ip)

<!-- /TOC -->
# 1. 网络层

**转发**涉及分组从一条入链路到一台路由器中的出链路的传送。**选路**涉及一个网络中的所有路由器，它们经选路协议共同交互，以决定分组从源到目的地结点所采用的路径。

## 1.1. 概述

路由器不运行应用层和传输层协议

### 1.1.1. 转发和选路

网络层的作用是把分组从发送主机移动到接收主机。为此，需要两种重要的功能：

* 转发。当一个分组到达某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。
* 选路。当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为选路算法。

每台路由器有一张**转发表**。路由通过检查到达分组首部中的一个字段，然后使用该值在该路由器的转发表中索引查询来转发一个分组。

**分组交换机**是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口道输出链路接口传送分组。某些分组交换机称为链路交换机。其他的分组交换机称为路由器。
### 1.1.2. 网络服务模型
网络服务模型定义网络的一侧边缘到另一侧边缘之间分组的端到端运输特性。

在发送主机，当运输层向网络层传递一个分组时，能由网络层提供的特定服务包括：
*  确保交付。该服务确保分组将最终到达目的地。
*  具有时延上界的确保交付。该服务不仅确保分组的交付，而且在特定的主机到主机时延上界内交付。

此外，下列服务能够为给定的源和目的之间提供分组的流：
*  有序分组交付。
*  确保最小带宽。
*  确保最大时延抖动。
*  安全性服务。

因特网的网络层称为**尽力而为的服务**。
## 1.2. 虚电路和数据报网络
运输层能够为网络提供无连接服务或面向连接服务。网络层也能提供无连接服务和连接服务。差异：
*  在网络层中，这些服务是由网络层想运输层提供的主机到主机的服务。在运输层中，这些服务是运输层向应用层提供的进程到进程的服务。
*  网络层或者提供主机到主机的无连接服务，或者提供主机到主机的连接服务，而不同时提供两种。仅在网络层提供链接服务的计算机网络称为**虚电路网络**。仅在网络层提供无连接服务的计算机网络被称为**数据报网络**。
*  在运输层实现面向连接的服务与在网络层中实现连接服务是根本不同的。运输层是在网络边缘的端系统中实现，网络层的连接服务除了在端系统中实现，还在网络核心的路由器中实现。

### 1.2.1. 虚电路网络
端系统向网络发送指示虚电路启动与终止的报文，以及路由器之间传递的用于建立虚电路的报文称为**信令报文**，用来交换这些报文的协议常被称为信令协议。
### 1.2.2. 数据报网络
在数据报网络中，每当一个端系统要发送分组时，它就为该分组加上目的端系统的地址，然后将分组推进网络中。

最长前缀匹配规则：在路右边中寻找最长的匹配项，并向与最长前缀匹配的链路接口转发该分组。
## 1.3. 路由器工作原理
![路由器体系结构](https://i.loli.net/2020/03/26/vFp4EgdGSQuLfZV.png)

路由器的四个组成部分：
*  输入端口。输入端口执行几项功能。它要执行将一条输入的物理链路端接到路由器的物理层功能。也要执行为了入链路远端的数据链路层功能交互的数据链路层功能。还要完成查找和转发功能。多个端口经常被集中到路由器的一块线路卡上。
*  交换结构。交换结构将路由器的输入端口连接到它的输出端口。
*  输出端口。输出端口存储经过交换结构转发给他的分组，并将这些分组传输到输出链路。
*  选路处理器。选路处理器执行选路协议，维护选路信息与转发表，并执行路由器中的网络管理功能。

### 1.3.1. 输入端口
输出端口的选择是使用转发表中包含的信息进行的，

### 1.3.2. 交换结构
通过交换结构，分组才能从一个输入端口交换到另一个输出端口。
![三种交换技术](https://i.loli.net/2020/03/26/iYqf3IFHtWmuUXd.png)
上图中的三种交换技术：
*  经内存交换。
*  经一根总线交换。
*  经互联网络交换。

### 1.3.3. 输出端口
![输出端口处理](https://i.loli.net/2020/03/26/yGlc7L8OYiw96Eu.png)
### 1.3.4. 何时出现排队
输出端口排队的后果就是，输出端口上的一个分组调度程序必须在这些排队的分组中选出一个来传送。

如果没有足够的内存来缓存一个入分组，那么必须做出决定：要么丢弃到达的分组，要么删除一个或多个已排队的分组以便为新来的分组腾出空间。
## 1.4. 网际协议：因特网中的转发和编址
因特网的网路层主要有三个组件。第一个是IP协议，第二个是选路组件，第三个是报告数据报中的差错和对某些网络层信息请求进行相应的设施。
### 1.4.1. 数据报格式
IPv4数据报的关键字：
*  版本号。着4比特规定了数据报的IP协议版本。
*  首部长度。一般的IP数据报都有20个字节的首部。
*  服务类型。
*  数据报长度。
*  标识、标志、片偏移。
*  寿命。
*  协议。该字段指定IP数据报部分应交给哪个运输层协议。
*  首部校验和。
*  源和目的IP地址。
*  选项。
*  数据（有效载荷）。

一个链路层帧所能承载的最大数据量叫做最大传输单元（Maximun Transmission Unit，MTU）。

当路由器中出链路的MTU比IP数据报小，就将数据报进行分片，用单独的链路层帧封装这些较小的IP数据报，然后向输出链路上发送这些帧。

片在其到达目的地运输层以前需要被重新组装。为了让目的主机执行重新组装任务，IPv4的设计者将标识、标志和片偏移字段放在IP首部，当创建一个数据报时，发送主机在为该数据设置源和目的地址的同时加上标识号。发送主机通常将它发送的每个数据报中的标识号加一。最后一个片的标志比特位被设为0。用片偏移字段指定片应该放在初始IP数据报的哪个位置。
### 1.4.2. IPv4编址
当主机中的IP想发送一个数据报时，它就在该链路上发送。主机与物理链路的边界为接口。

路由器与它的任意一条链路之间的边界也叫做接口。一个IP地址再技术上是与一个接口相关联的。

分类编址：听过把IP地址的网络部分限制为8比特、16比特和24比特，来构成A类、B类和C类地址。

当一台主机发出一个目的地址为255.255.255.255的数据报时，该报文会被交付给同一个子网下的所有主机。

动态主机配置协议DHCP：主机可以自动获取IP地址。

网络地址转换NAT：把子网主机和网络主机IP进行转换。

### 1.4.3. ICMP：互联网控制报文协议
ICMP用于主机和路由器彼此交换网络层信息。
## 1.5. 选路算法
一台主机通常直接和一台路由器相连接，该路由器称为该主机的默认路由器，又称为该主机的第一跳路由器。
## 1.6. 因特网中的选路
### 1.6.1. 因特网中自治系统内部选路：IP
选路信息协议：RIP

开放最短路径优先：OSPF

RIP是一种距离向量协议。一条路径的最大费用被限制为15，因此RIP被限制在网络直径不超过15跳的自治系统内。在RIP中，选路更新信息在邻居之间通过RIP响应报文交换大约30秒交换一次。

